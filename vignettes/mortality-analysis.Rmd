---
title: "Modeling Mortality Trends with Functional Forecasting"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Modeling Mortality Trends with Functional Forecasting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(ffc)
library(ggplot2)
library(marginaleffects)
theme_set(theme_bw())
```

## Introduction

Mortality patterns represent one of the most fundamental demographic processes, yet traditional statistical approaches often miss the complex, evolving functional relationships between age and death rates over time. This vignette demonstrates how functional forecasting using the `ffc` package captures these dynamic relationships that change shape—not just magnitude—over time.

### What makes mortality data ideal for functional forecasting?

1. Complex age patterns: Mortality exhibits characteristic J-shaped curves across age groups
2. Temporal evolution: These functional relationships shift systematically over time  
3. Smooth transitions: Changes occur gradually, making them suitable for GAM-based smoothing
4. Forecasting relevance: Understanding future mortality trends has critical policy implications

### Key concepts we'll explore

- Time-varying coefficients: How functional relationships evolve over time
- Hierarchical smoothing: Modeling shared trends with group-specific deviations  
- Functional forecasting: Predicting entire curves into the future
- Model diagnostics: Validating functional time series models

## Data exploration

We'll use Queensland mortality data spanning 1980-2020, containing death counts by age, sex, and year with corresponding population denominators.

```{r}
data("qld_mortality")
head(qld_mortality, 15)
```

The dataset structure is ideal for functional analysis: we have a functional predictor (age) whose relationship with the outcome (mortality) changes over time (year), with hierarchical structure (sex).

### Visualizing mortality patterns

```{r mortality-curves, fig.cap="Observed mortality rates by age in Queensland, 1980-2020. The characteristic J-shaped curves show systematic downward shifts over time, indicating mortality improvements across all age groups."}
ggplot(
  data = qld_mortality,
  aes(
    x = age,
    y = deaths / population,
    group = year,
    colour = year
  )
) +
  geom_line(alpha = 0.7) +
  facet_wrap(~sex) +
  scale_colour_viridis_c(name = "Year") +
  labs(
    x = "Age", 
    y = "Mortality rate",
    title = "Queensland mortality patterns over time"
  ) +
  scale_y_log10()
```

Key observations:

- J-shaped curves: High infant mortality, low childhood mortality, exponential increase with age
- Temporal shifts: Consistent downward movement of entire curves over time  
- Sex differences: Males consistently higher mortality, similar temporal patterns
- Functional evolution: The shape itself evolves, not just vertical shifts
- Overall decline: Mortality rates have declined substantially across all ages, reflecting major improvements in healthcare, lifestyle, and living conditions

## Functional modeling approach

### Why traditional models fall short

Standard approaches might model this as:
```r
# Traditional approach - misses functional evolution
glm(deaths ~ age + year + sex, family = poisson(), offset = log(population))
```

This assumes linear age effects and additive time trends—clearly inadequate for evolving functional relationships.

### The ffc solution: time-varying coefficients

The `fts()` function creates basis functions whose coefficients evolve over time, capturing how the age-mortality relationship changes:

```{r fit-model, fig.show='hide'}
mod <- ffc_gam(
  deaths ~
    offset(log(population)) +
    sex +
    # Time-varying level: shared temporal trends
    fts(
      year,
      mean_only = TRUE,
      bs = "tp",
      time_k = 35,
      time_m = 1
    ) +
    # Time-varying age effects: sex-specific deviations
    fts(
      age,
      by = sex,
      bs = "tp", 
      time_k = 15,
      time_m = 1
    ),
  time = "year",
  data = qld_mortality,
  family = poisson(),
  # Efficient for large datasets
  engine = "bam"
)
```

### Understanding the model structure

```{r model-summary}
summary(mod)
```

Key components:

1. Fixed effects: `sex` captures baseline male-female differences
2. Time-varying level: `fts(year, mean_only = TRUE)` models shared temporal trends  
3. Time-varying functions: `fts(age, by = sex)` captures how age patterns evolve differently by sex

The model automatically creates a hierarchical structure where basis functions become `by` variables in smooths of time, sharing smoothing parameters for computational efficiency.

## Model interpretation

### Predicted functional curves

```{r predicted-curves, fig.cap="Model predictions showing expected mortality curves by age and year. Smooth curves demonstrate systematic evolution of the age-mortality relationship over four decades."}
newdat <- qld_mortality
newdat$population <- 1  # Standardized predictions

newdat$preds <- predict(
  mod,
  newdata = newdat,
  type = "response"
)

ggplot(
  data = newdat,
  aes(
    x = age,
    y = preds,
    group = year,
    colour = year
  )
) +
  geom_line() +
  facet_wrap(~sex) +
  scale_colour_viridis_c(name = "Year") +
  labs(
    x = "Age",
    y = "Expected mortality rate",
    title = "Model predictions: evolving mortality patterns"
  ) +
  scale_y_log10()
```

The model successfully captures the smooth evolution of J-shaped mortality curves while preserving the characteristic functional form. The downward trend across all mortality curves demonstrates substantial improvement in survival rates over the 40-year period. This reflects major advances in healthcare, improved living conditions, better nutrition, and reduced exposure to environmental hazards. Notably, the decline is not uniform across all ages - the model captures how the rate of improvement varies by age group and sex, with some periods showing more rapid mortality decline than others.

### Focused analysis: teenage mortality trends

Let's examine how mortality patterns changed for a specific age group by leveraging the power of `marginaleffects`:

```{r mortality-trends, fig.cap="Predicted mortality trends for 17-year-olds in Queensland, 1980-2020. Shows approximately 70% decline in mortality rates with consistent male-female differences."}
plot_predictions(
  mod,
  by = c("year", "sex"),
  newdata = datagrid(
    age = 17,
    year = unique,
    sex = unique,
    population = 1
  ),
  type = "response"
) +
  labs(
    x = "Year",
    y = "Expected mortality rate",
    title = "Teenage mortality trends over time"
  ) +
  scale_y_log10()
```

### Rate of change analysis

We can look deeper at these predictions to understand *how fast* mortality is improving, again using `marginaleffects` support:

```{r mortality-derivatives, fig.cap="First derivatives showing the rate of mortality improvement for 17-year-olds. Fluctuations reveal periods of faster and slower mortality decline."}
plot_slopes(
  mod,
  variables = "year",
  by = c("year", "sex"),
  newdata = datagrid(
    age = 17,
    year = unique,
    sex = unique,
    population = 1
  ),
  type = "response"
) +
  labs(
    x = "Year",
    y = "Rate of mortality change",
    title = "Speed of mortality improvement over time"
  ) +
  geom_hline(
    yintercept = 0,
    linetype = "dashed",
    alpha = 0.7
  )
```


## Extracting time-varying coefficients

The power of functional forecasting lies in treating the evolving coefficients as time series that can be forecasted:

```{r extract-coefficients}
functional_coefs <- fts_coefs(
  mod,
  summary = FALSE,
  times = 10
)
functional_coefs
```

### Visualizing coefficient evolution

```{r plot-coefficients, fig.cap="Time series of functional basis coefficients. Each panel shows how different aspects of the age-mortality relationship evolved over time, revealing complex temporal dependencies."}
autoplot(functional_coefs) +
  labs(title = "Evolution of functional basis coefficients")
```

Interpretation:

- Complex patterns: Each coefficient series shows distinct temporal behavior
- Smooth evolution: Changes occur gradually, suitable for time series modeling
- Interdependence: Multiple coefficients work together to create the functional evolution

## Forecasting mortality patterns

### Coefficient forecasting

```{r forecast-coefficients}
functional_fc <- forecast(
  object = functional_coefs,
  h = 5,      # 5-year horizon
  times = 10, # Forecast replicates
  model = "ARIMA"
)
functional_fc
```

The forecast includes uncertainty in both the time series models and the original coefficient estimation, providing realistic prediction intervals.

### Future mortality patterns

Let's demonstrate how to generate complete mortality curve forecasts by combining the forecasted coefficients with the model structure:

```{r forecast-curves, fig.cap="Forecasted mortality curves for Queensland, 2021-2025. Shows how the functional forecasting approach predicts future age-mortality patterns."}
# Create forecast data for future years
future_years <- 2021:2025
newdata_forecast <- expand.grid(
  age = unique(qld_mortality$age),
  sex = unique(qld_mortality$sex),
  year = future_years,
  population = 1
)

# Generate forecasted mortality curves using forecast()
# This integrates the time series forecasts of coefficients
mortality_forecasts <- forecast(
  object = mod,
  newdata = newdata_forecast,
  model = "ARIMA",
  type = "expected"
)
head(mortality_forecasts)

# Plot forecasted mortality rates, together with uncertainties
ggplot(mortality_forecasts |>
         dplyr::bind_cols(newdata_forecast),
       aes(x = age,
           y = .estimate,
           group = year,
           colour = year)) +
  geom_ribbon(aes(
    ymin = .q10,
    ymax = .q90,
    fill = year
  ),
  alpha = 0.2,
  colour = NA) +
  geom_line() +
  facet_wrap(~sex) +
  scale_colour_viridis_c(name = "Year") +
  scale_fill_viridis_c(name = "Year") +
  labs(
    x = "Age", 
    y = "Mortality rate",
    title = "Expected mortality"
  ) +
  scale_y_log10()
```

This forecasting approach enables prediction of entire functional relationships by combining time series forecasts of the functional coefficients with the underlying model structure. We could easily then convert this to a `fable` object (using `as_fable()`) and compare with holdout data to compute any of the forecast scores supported by `fable`.

## Key insights and methodology

### What we learned about Queensland mortality

- Systematic improvement: Mortality declined across all age groups over 40 years
- Functional evolution: Changes involved curve shape, not just magnitude shifts
- Heterogeneous trends: Rate of improvement varied by age and sex
- Complex patterns: Simple parametric models would miss these relationships

### Why functional forecasting matters

1. Captures complexity: Models evolving functional relationships traditional methods miss
2. Preserves structure: Maintains biological/physical constraints in forecasts  
3. Quantifies uncertainty: Propagates uncertainty through the entire functional evolution
4. Policy relevance: Enables sophisticated demographic projections

### Model design principles

- Hierarchical structure: Shared trends with group-specific deviations
- Temporal smoothing: Balance flexibility with smoothness using `time_k` and `time_m`
- Basis choice: Thin plate splines work well for age and time
- Computational efficiency: `bam()` engine handles large datasets effectively

## Extensions and further analysis

### Advanced features

The `ffc` package supports additional complexity:  
- Multiple functional predictors: `fts(age) + fts(time_since_event)`  
- Interaction effects: Functional relationships that depend on other variables  
- Alternative distributions: Beyond Poisson to handle different data types  

## Conclusion

Functional forecasting with `ffc` provides a principled approach to modeling and predicting evolving functional relationships. By treating time-varying coefficients as forecastable time series, we can:

1. Capture complexity that traditional methods miss
2. Generate realistic forecasts of entire functional relationships  
3. Quantify uncertainty appropriately across all sources
4. Provide actionable insights for policy and planning

The Queensland mortality analysis demonstrates these capabilities in a real-world context, revealing patterns and trends that inform our understanding of demographic change and enable sophisticated projection methods for public health planning.
