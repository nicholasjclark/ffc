<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Forecasting El Niño Patterns with Cyclic Splines and Dynamic Factor Models • ffc</title>
<!-- katex math --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Forecasting El Niño Patterns with Cyclic Splines and Dynamic Factor Models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ffc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/mortality-analysis.html">Modeling Mortality Trends with Functional Forecasting</a></li>
    <li><a class="dropdown-item" href="../articles/elnino-forecasting.html">Forecasting El Niño Patterns with Cyclic Splines and Dynamic Factor Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nicholasjclark/ffc" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Forecasting El Niño Patterns with Cyclic Splines and Dynamic Factor Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/ffc/blob/main/vignettes/elnino-forecasting.Rmd" class="external-link"><code>vignettes/elnino-forecasting.Rmd</code></a></small>
      <div class="d-none name"><code>elnino-forecasting.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nicholasjclark.github.io/ffc">ffc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marginaleffects.com/" class="external-link">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fable.tidyverts.org" class="external-link">fable</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tsibble.tidyverts.org" class="external-link">tsibble</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Sea surface temperature (SST) in the tropical Pacific exhibits
complex seasonal patterns that evolve dramatically during El
Niño-Southern Oscillation (ENSO) events. Traditional time series methods
often struggle to capture both the cyclic seasonal structure and the
inter-annual variability that characterizes these ocean-atmosphere
interactions. This vignette demonstrates how functional forecasting with
the <a href="https://github.com/njtierney/ffc" class="external-link"><code>ffc</code></a>
package addresses these challenges through:</p>
<ol style="list-style-type: decimal">
<li>Cyclic cubic splines that naturally handle periodic seasonal
patterns<br>
</li>
<li>Gaussian Process Dynamic Factor (GPDF) models for sophisticated
multivariate forecasting<br>
</li>
<li>Innovative validation techniques</li>
</ol>
<div class="section level3">
<h3 id="the-forecasting-challenge">The forecasting challenge<a class="anchor" aria-label="anchor" href="#the-forecasting-challenge"></a>
</h3>
<p>El Niño SST data presents unique modeling challenges: - Strong
seasonal cycles that must connect smoothly at year boundaries<br>
- Inter-annual variability driven by complex ocean-atmosphere coupling -
Non-stationary patterns during ENSO transitions - Multiple correlated
time series of functional coefficients</p>
</div>
<div class="section level3">
<h3 id="our-approach-functional-coefficients-meet-dynamic-factors">Our approach: functional coefficients meet dynamic factors<a class="anchor" aria-label="anchor" href="#our-approach-functional-coefficients-meet-dynamic-factors"></a>
</h3>
<p>The <code>ffc</code> package treats seasonal patterns as smooth
functions whose shapes evolve over time. By combining <a href="https://cran.r-project.org/package=mgcv" class="external-link"><code>mgcv</code></a>
GAM-based functional regression with <a href="https://mc-stan.org/" class="external-link"><code>Stan</code></a>-powered dynamic factor
models, we can:<br>
- Preserve seasonal continuity while allowing flexible evolution<br>
- Capture shared trends across multiple coefficient series<br>
- Generate probabilistic forecasts with proper uncertainty
quantification<br>
- Validate predictions using state-of-the-art functional data
metrics</p>
</div>
</div>
<div class="section level2">
<h2 id="data-exploration">Data exploration<a class="anchor" aria-label="anchor" href="#data-exploration"></a>
</h2>
<p>We’ll use monthly SST data from El Niño regions 1 and 2, spanning
1982-2018:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"elnino_sst"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">elnino_sst</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 444</span></span>
<span><span class="co">#&gt; Columns: 3</span></span>
<span><span class="co">#&gt; Key: month [12]</span></span>
<span><span class="co">#&gt; $ year        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1982<span style="color: #949494;">, </span>1983<span style="color: #949494;">, </span>1984<span style="color: #949494;">, </span>1985<span style="color: #949494;">, </span>1986<span style="color: #949494;">, </span>1987<span style="color: #949494;">, </span>1988<span style="color: #949494;">, </span>1989<span style="color: #949494;">, </span>1990<span style="color: #949494;">, </span>1991…</span></span>
<span><span class="co">#&gt; $ month       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1<span style="color: #949494;">, </span>1…</span></span>
<span><span class="co">#&gt; $ temperature <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 24.29<span style="color: #949494;">, </span>27.42<span style="color: #949494;">, </span>24.18<span style="color: #949494;">, </span>23.59<span style="color: #949494;">, </span>24.61<span style="color: #949494;">, </span>25.30<span style="color: #949494;">, </span>24.64<span style="color: #949494;">, </span>24.09<span style="color: #949494;">, </span>24…</span></span>
<span></span>
<span><span class="co"># Check temporal coverage</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Years covered:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">elnino_sst</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, <span class="st">"-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">elnino_sst</span><span class="op">$</span><span class="va">year</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Years covered: 1982 - 2018</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total observations:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">elnino_sst</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Total observations: 444</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Monthly measurements per year:"</span>, <span class="va">elnino_sst</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tsibble.tidyverts.org/reference/index-by.html" class="external-link">index_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Monthly measurements per year: 12</span></span></code></pre></div>
<div class="section level3">
<h3 id="visualizing-seasonal-patterns">Visualizing seasonal patterns<a class="anchor" aria-label="anchor" href="#visualizing-seasonal-patterns"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">elnino_sst</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span>, y <span class="op">=</span> <span class="va">temperature</span>, group <span class="op">=</span> <span class="va">year</span>, color <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span>, linewidth <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, labels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Month"</span>, </span>
<span>    y <span class="op">=</span> <span class="st">"Temperature (°C)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"El Niño SST: Evolving seasonal patterns"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/seasonal-patterns-1.png" class="r-plt" alt="Monthly SST patterns across years." width="672"><p class="caption">
Monthly SST patterns across years.
</p>
</div>
</div>
<div class="section level3">
<h3 id="identifying-enso-events">Identifying ENSO events<a class="anchor" aria-label="anchor" href="#identifying-enso-events"></a>
</h3>
<p>Let’s examine annual means to identify major El Niño and La Niña
events:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">annual_means</span> <span class="op">&lt;-</span> <span class="va">elnino_sst</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/index-by.html" class="external-link">index_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temperature</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    anomaly <span class="op">=</span> <span class="va">mean_temp</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_temp</span><span class="op">)</span>,</span>
<span>    phase <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">anomaly</span> <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="op">~</span> <span class="st">"El Niño"</span>,</span>
<span>      <span class="va">anomaly</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">~</span> <span class="st">"La Niña"</span>, </span>
<span>      <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Neutral"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">annual_means</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">anomaly</span>, fill <span class="op">=</span> <span class="va">phase</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"El Niño"</span> <span class="op">=</span> <span class="st">"darkred"</span>, <span class="st">"La Niña"</span> <span class="op">=</span> <span class="st">"darkblue"</span>, <span class="st">"Neutral"</span> <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="st">"ENSO Phase"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Temperature anomaly (°C)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"ENSO phases in the observational record"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/enso-identification-1.png" class="r-plt" alt="Annual mean SST anomalies highlighting major ENSO events. The 1997-1998 and 2015-2016 El Niño events stand out as extreme warm phases." width="672"><p class="caption">
Annual mean SST anomalies highlighting major ENSO events. The 1997-1998
and 2015-2016 El Niño events stand out as extreme warm phases.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="modeling-with-cyclic-splines">Modeling with cyclic splines<a class="anchor" aria-label="anchor" href="#modeling-with-cyclic-splines"></a>
</h2>
<div class="section level3">
<h3 id="train-test-split-for-validation">Train-test split for validation<a class="anchor" aria-label="anchor" href="#train-test-split-for-validation"></a>
</h3>
<p>We’ll use data through 2014 for training and reserve 2015-2018 for
validation—a period that includes the major 2015-2016 El Niño:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="va">elnino_sst</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&lt;=</span> <span class="fl">2014</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">elnino_sst</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;</span> <span class="fl">2014</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-functional-model-specification">The functional model specification<a class="anchor" aria-label="anchor" href="#the-functional-model-specification"></a>
</h3>
<p>The key innovation is using cyclic cubic splines for the monthly
pattern:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_elnino</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ffc_gam.html">ffc_gam</a></span><span class="op">(</span></span>
<span>  <span class="va">temperature</span> <span class="op">~</span></span>
<span>    <span class="co"># Time-varying intercept: captures inter-annual variability</span></span>
<span>    <span class="fu"><a href="../reference/fts.html">fts</a></span><span class="op">(</span></span>
<span>      <span class="va">year</span>, </span>
<span>      mean_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      time_k <span class="op">=</span> <span class="fl">15</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    </span>
<span>    <span class="co"># Time-varying seasonal pattern: cyclic splines ensure continuity</span></span>
<span>    <span class="fu"><a href="../reference/fts.html">fts</a></span><span class="op">(</span></span>
<span>      <span class="va">month</span>, </span>
<span>      k <span class="op">=</span> <span class="fl">12</span>, </span>
<span>      bs <span class="op">=</span> <span class="st">"cc"</span>, </span>
<span>      time_k <span class="op">=</span> <span class="fl">15</span></span>
<span>    <span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">train_data</span>,</span>
<span>  </span>
<span>  <span class="co"># Specify cyclic boundaries for month</span></span>
<span>  knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">12.5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="st">"year"</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="understanding-the-model-structure">Understanding the model structure<a class="anchor" aria-label="anchor" href="#understanding-the-model-structure"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod_elnino</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Family: gaussian </span></span>
<span><span class="co">#&gt; Link function: identity </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Formula:</span></span>
<span><span class="co">#&gt; temperature ~ s(year, by = fts_year1_mean, bs = "ts", k = 15, </span></span>
<span><span class="co">#&gt;     m = 2, id = 1) + s(year, by = fts_bs_s_month__1, bs = "ts", </span></span>
<span><span class="co">#&gt;     k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__2, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__3, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__4, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__5, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__6, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__7, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__8, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__9, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2) + s(year, by = fts_bs_s_month__10, </span></span>
<span><span class="co">#&gt;     bs = "ts", k = 15, m = 2, id = 2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Parametric coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept) 23.15273    0.05393   429.3   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Approximate significance of smooth terms:</span></span>
<span><span class="co">#&gt;                               edf Ref.df      F  p-value    </span></span>
<span><span class="co">#&gt; s(year):fts_year1_mean     13.597     14  7.663  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__1   1.893     15  1.619 1.01e-06 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__2   2.013     15 16.873  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__3   1.954     15  7.713  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__4   2.005     15  2.699  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__5   1.994     15  0.097   0.4697    </span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__6   1.994     15  3.880  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__7   2.005     15 11.273  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__8   1.954     15  7.704  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__9   2.013     15  6.652  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; s(year):fts_bs_s_month__10  1.893     15  0.495   0.0122 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; R-sq.(adj) =  0.804   Deviance explained =   82%</span></span>
<span><span class="co">#&gt; GCV = 1.2609  Scale est. = 1.1516    n = 396</span></span></code></pre></div>
<p>The model decomposes SST into: 1. <strong>Smooth inter-annual
trend</strong>: <code>fts(year, mean_only = TRUE)</code><br>
2. <strong>Evolving seasonal cycle</strong>:
<code>fts(month, bs = "cc")</code> with cyclic boundaries</p>
<p>The cyclic spline ensures December flows smoothly into January,
critical for seasonal forecasting.</p>
</div>
</div>
<div class="section level2">
<h2 id="model-diagnostics-and-interpretation">Model diagnostics and interpretation<a class="anchor" aria-label="anchor" href="#model-diagnostics-and-interpretation"></a>
</h2>
<div class="section level3">
<h3 id="visualizing-fitted-seasonal-cycles">Visualizing fitted seasonal cycles<a class="anchor" aria-label="anchor" href="#visualizing-fitted-seasonal-cycles"></a>
</h3>
<p>We can use <code><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions()</a></code> from <a href="https://marginaleffects.com/" class="external-link"><code>marginaleffects</code></a> for
quick and effortless effect plots on the outcome scale. For example, the
below plot shows how our model’s fitted seasonal shapes vary over
time:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/r/plot_predictions.html" class="external-link">plot_predictions</a></span><span class="op">(</span><span class="va">mod_elnino</span>, condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"month"</span>, <span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Month"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Temperature (°C)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Predicted training-period seasonal cycles"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/fitted-cycles-1.png" class="r-plt" alt="Fitted seasonal cycles for selected years. The model captures both the mean seasonal pattern and year-specific deviations." width="672"><p class="caption">
Fitted seasonal cycles for selected years. The model captures both the
mean seasonal pattern and year-specific deviations.
</p>
</div>
</div>
<div class="section level3">
<h3 id="extracting-time-varying-coefficients">Extracting time-varying coefficients<a class="anchor" aria-label="anchor" href="#extracting-time-varying-coefficients"></a>
</h3>
<p>The functional coefficients reveal the underlying dynamics of the
model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract coefficients with their time series structure</span></span>
<span><span class="va">func_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fts_coefs.ffc_gam.html">fts_coefs</a></span><span class="op">(</span><span class="va">mod_elnino</span>, summary <span class="op">=</span> <span class="cn">FALSE</span>, times <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">func_coefs</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3,630 × 6</span></span></span>
<span><span class="co">#&gt;    .basis         .parameter .time .estimate .realisation  year</span></span>
<span><span class="co">#&gt;  <span style="color: #BCBCBC;">*</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>982    0.991             1  <span style="text-decoration: underline;">1</span>982</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>983    0.415             1  <span style="text-decoration: underline;">1</span>983</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>984    0.049<span style="text-decoration: underline;">0</span>            1  <span style="text-decoration: underline;">1</span>984</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>985   -<span style="color: #BB0000;">0.042</span><span style="color: #BB0000; text-decoration: underline;">0</span>            1  <span style="text-decoration: underline;">1</span>985</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>986   -<span style="color: #BB0000;">0.039</span><span style="color: #BB0000; text-decoration: underline;">5</span>            1  <span style="text-decoration: underline;">1</span>986</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>987   -<span style="color: #BB0000;">0.198</span>             1  <span style="text-decoration: underline;">1</span>987</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>988   -<span style="color: #BB0000;">0.528</span>             1  <span style="text-decoration: underline;">1</span>988</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>989   -<span style="color: #BB0000;">0.701</span>             1  <span style="text-decoration: underline;">1</span>989</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>990   -<span style="color: #BB0000;">0.398</span>             1  <span style="text-decoration: underline;">1</span>990</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> fts_year1_mean location    <span style="text-decoration: underline;">1</span>991    0.235             1  <span style="text-decoration: underline;">1</span>991</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 3,620 more rows</span></span></span>
<span></span>
<span><span class="co"># Visualize coefficient evolution</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">func_coefs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Time-varying basis coefficients"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="elnino-forecasting_files/figure-html/extract-coefficients-1.png" class="r-plt" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="forecasting-ffc-models">Forecasting <code>ffc</code> models<a class="anchor" aria-label="anchor" href="#forecasting-ffc-models"></a>
</h2>
<div class="section level3">
<h3 id="exponential-smoothing-forecasts-of-functional-coefficients">Exponential Smoothing forecasts of functional coefficients<a class="anchor" aria-label="anchor" href="#exponential-smoothing-forecasts-of-functional-coefficients"></a>
</h3>
<p>The “ETS” model uses automatic exponential smoothing (Error, Trend,
Seasonal) to independently forecast each basis function coefficient. ETS
models are particularly effective for time series with clear trends and
seasonal patterns, automatically selecting the optimal combination of
error type (additive/multiplicative), trend (none/additive/damped), and
seasonal components. Each coefficient is modeled separately, allowing
the method to adapt to the unique temporal dynamics of each basis
function. For more details on exponential smoothing methods, see <a href="https://otexts.com/fpp3/expsmooth.html" class="external-link">Hyndman &amp;
Athanasopoulos (2021)</a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Forecast coefficients using ETS</span></span>
<span><span class="va">coef_forecast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">func_coefs</span>,</span>
<span>  h <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"ETS"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize forecasts for plotting</span></span>
<span><span class="va">forecast_summary</span> <span class="op">&lt;-</span> <span class="va">coef_forecast</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.basis</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.sim</span><span class="op">)</span>,</span>
<span>    q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.sim</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    q10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.sim</span>, <span class="fl">0.10</span><span class="op">)</span>,</span>
<span>    q90 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.sim</span>, <span class="fl">0.90</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.sim</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Add historical values for context</span></span>
<span><span class="va">historical_summary</span> <span class="op">&lt;-</span> <span class="va">func_coefs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.basis</span>, <span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.estimate</span><span class="op">)</span>,</span>
<span>    q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.estimate</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    q10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.estimate</span>, <span class="fl">0.10</span><span class="op">)</span>,</span>
<span>    q90 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.estimate</span>, <span class="fl">0.90</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.estimate</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot with ribbons for each basis function</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">forecast_summary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q05</span>, ymax <span class="op">=</span> <span class="va">q95</span>, fill <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q10</span>, ymax <span class="op">=</span> <span class="va">q90</span>, fill <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean</span>, color <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">historical_summary</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q05</span>, ymax <span class="op">=</span> <span class="va">q95</span>, fill <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">historical_summary</span>,</span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q10</span>, ymax <span class="op">=</span> <span class="va">q90</span>, fill <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">historical_summary</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">mean</span>, color <span class="op">=</span> <span class="va">.basis</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">2014.5</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">.basis</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_d</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_d</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Coefficient value"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Forecasted functional basis coefficients"</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="elnino-forecasting_files/figure-html/forecast-gpdf-1.png" class="r-plt" width="672"></p>
</div>
<div class="section level3">
<h3 id="generating-temperature-forecasts-with-gpdf">Generating temperature forecasts with GPDF<a class="anchor" aria-label="anchor" href="#generating-temperature-forecasts-with-gpdf"></a>
</h3>
<p>Transform coefficient forecasts back to temperature predictions using
Gaussian Process Dynamic Factor (GPDF) models. The GPDF approach models
the evolution of multiple time series through a lower-dimensional set of
latent factors, each following a Gaussian process. This captures complex
dependencies between the different basis coefficients while providing
principled uncertainty quantification. The model estimates K latent
factors that drive the dynamics of all coefficients jointly, leading to
more coherent forecasts than independent modeling. The Gaussian process
priors on the factors allow for flexible non-linear dynamics while
maintaining smoothness. For theoretical background on Gaussian
processes, see <a href="https://betanalpha.github.io/assets/case_studies/gaussian_processes.html" class="external-link">Michael
Betancourt’s case study</a>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create forecast data grid</span></span>
<span><span class="va">forecast_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  month <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2015</span><span class="op">:</span><span class="fl">2018</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html" class="external-link">as_tsibble</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">year</span>, key <span class="op">=</span> <span class="va">month</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate temperature forecasts</span></span>
<span><span class="va">temp_forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span></span>
<span>  <span class="va">mod_elnino</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">forecast_grid</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"GPDF"</span>,</span>
<span>  mean_model <span class="op">=</span> <span class="st">"ETS"</span>,</span>
<span>  K <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine with actual test data for comparison</span></span>
<span><span class="va">forecast_results</span> <span class="op">&lt;-</span> <span class="va">temp_forecasts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="va">forecast_grid</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">test_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, actual <span class="op">=</span> <span class="va">temperature</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot forecasts vs actuals</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">forecast_results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">month</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.q2.5</span>, ymax <span class="op">=</span> <span class="va">.q97.5</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.q10</span>, ymax <span class="op">=</span> <span class="va">.q90</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"darkred"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">actual</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">actual</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, labels <span class="op">=</span> <span class="va">month.abb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Month"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Temperature (C)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Forecast validation: 2015-2018"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Red: forecast (with 80% and 95% PIs), Black: observed"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/temperature-forecast-1.png" class="r-plt" alt="Forecasted seasonal cycles for 2015-2018 with uncertainty bands." width="672"><p class="caption">
Forecasted seasonal cycles for 2015-2018 with uncertainty bands.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="spectral-validation">Spectral validation<a class="anchor" aria-label="anchor" href="#spectral-validation"></a>
</h2>
<p>We can also check if the model preserves the spectral characteristics
of the original data. Spectral analysis decomposes time series into
frequency components, revealing periodic patterns and their strengths.
For El Niño data, we expect to see dominant annual cycles (frequency =
1) and potentially sub-annual harmonics. A good forecast should preserve
these fundamental frequency characteristics, ensuring that the predicted
seasonal patterns maintain the same spectral signature as the observed
data. This validation is particularly important for functional
forecasting where we want to ensure the cyclical nature of the data is
maintained across the forecast horizon.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Spectral analysis with uncertainty quantification</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate spectrum for observed data</span></span>
<span><span class="va">actual_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">forecast_results</span><span class="op">$</span><span class="va">actual</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">actual_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spectrum.html" class="external-link">spectrum</a></span><span class="op">(</span><span class="va">actual_ts</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate spectra for forecast ensemble (using quantiles)</span></span>
<span><span class="va">forecast_spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">quantiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.10</span>, <span class="fl">0.50</span>, <span class="fl">0.90</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">q</span> <span class="kw">in</span> <span class="va">quantiles</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">forecast_q</span> <span class="op">&lt;-</span> <span class="va">forecast_results</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">".q"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.0f"</span>, <span class="va">q</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">forecast_q</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Handle different quantile naming conventions</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">q</span> <span class="op">==</span> <span class="fl">0.05</span><span class="op">)</span> <span class="va">forecast_q</span> <span class="op">&lt;-</span> <span class="va">forecast_results</span><span class="op">$</span><span class="va">.q2.5</span></span>
<span>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">q</span> <span class="op">==</span> <span class="fl">0.95</span><span class="op">)</span> <span class="va">forecast_q</span> <span class="op">&lt;-</span> <span class="va">forecast_results</span><span class="op">$</span><span class="va">.q97.5</span></span>
<span>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">q</span> <span class="op">==</span> <span class="fl">0.50</span><span class="op">)</span> <span class="va">forecast_q</span> <span class="op">&lt;-</span> <span class="va">forecast_results</span><span class="op">$</span><span class="va">.estimate</span></span>
<span>    <span class="kw">else</span> <span class="kw">next</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">forecast_ts_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">forecast_q</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="va">forecast_spec_q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spectrum.html" class="external-link">spectrum</a></span><span class="op">(</span><span class="va">forecast_ts_q</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">forecast_spectra</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"q"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.0f"</span>, <span class="va">q</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    frequency <span class="op">=</span> <span class="va">forecast_spec_q</span><span class="op">$</span><span class="va">freq</span>,</span>
<span>    power <span class="op">=</span> <span class="va">forecast_spec_q</span><span class="op">$</span><span class="va">spec</span>,</span>
<span>    quantile <span class="op">=</span> <span class="va">q</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine spectral estimates</span></span>
<span><span class="va">forecast_spec_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">forecast_spectra</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate summary statistics across quantiles for each frequency</span></span>
<span><span class="va">forecast_summary</span> <span class="op">&lt;-</span> <span class="va">forecast_spec_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">frequency</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">power</span><span class="op">)</span>,</span>
<span>    q05 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">power</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">power</span>, <span class="fl">0.10</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>    q90 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">power</span>, <span class="fl">0.90</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">power</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Observed spectrum data</span></span>
<span><span class="va">observed_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  frequency <span class="op">=</span> <span class="va">actual_spec</span><span class="op">$</span><span class="va">freq</span>,</span>
<span>  power <span class="op">=</span> <span class="va">actual_spec</span><span class="op">$</span><span class="va">spec</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create plot with uncertainty bands</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Forecast uncertainty bands</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">forecast_summary</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">frequency</span>, ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">q05</span><span class="op">)</span>, ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">q95</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span>, fill <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">forecast_summary</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">frequency</span>, ymin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">q10</span><span class="op">)</span>, ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">q90</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.3</span>, fill <span class="op">=</span> <span class="st">"darkred"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Forecast median</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">forecast_summary</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">frequency</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"darkred"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Observed spectrum</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">observed_df</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">frequency</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">power</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>, linewidth <span class="op">=</span> <span class="fl">1.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Highlight annual frequency</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">1.1</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">observed_df</span><span class="op">$</span><span class="va">power</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.9</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Annual cycle"</span>, hjust <span class="op">=</span> <span class="fl">0</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Frequency (cycles per year)"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Log spectral density"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Spectral validation with forecast uncertainty"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Black: observed, Red: forecast median with 80% and 90% bands"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/spectral-validation-1.png" class="r-plt" alt="Spectral density comparison with uncertainties. The forecast preserves the key frequency components with quantified uncertainty bands." width="672"><p class="caption">
Spectral density comparison with uncertainties. The forecast preserves
the key frequency components with quantified uncertainty bands.
</p>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-fable-ecosystem">Integration with fable ecosystem<a class="anchor" aria-label="anchor" href="#integration-with-fable-ecosystem"></a>
</h2>
<p>The <code>ffc</code> package provides seamless integration with the
<a href="https://fable.tidyverts.org/" class="external-link"><code>fable</code></a> ecosystem
through the <code><a href="https://fabletools.tidyverts.org/reference/as-fable.html" class="external-link">as_fable()</a></code> function. This allows ffc forecasts
to be converted to fable objects, enabling use of fable’s accuracy
metrics and visualization tools:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert ffc forecasts to fable format</span></span>
<span><span class="va">fable_forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://fabletools.tidyverts.org/reference/as-fable.html" class="external-link">as_fable</a></span><span class="op">(</span></span>
<span>  <span class="va">mod_elnino</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">test_data</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"ENS"</span>,</span>
<span>  mean_model <span class="op">=</span> <span class="st">"ETS"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Evaluate forecast accuracy using fable metrics</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/accuracy.html" class="external-link">accuracy</a></span><span class="op">(</span><span class="va">fable_forecasts</span>, <span class="va">test_data</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 12 × 11</span></span></span>
<span><span class="co">#&gt;    .model  month .type    ME  RMSE   MAE   MPE  MAPE  MASE RMSSE      ACF1</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> FFC_ENS     1 Test  0.360 1.04  0.963 1.30   3.82   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.237</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> FFC_ENS     2 Test  0.122 0.947 0.845 0.339  3.17   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.302</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> FFC_ENS     3 Test  0.449 1.07  0.904 1.52   3.28   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.327</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> FFC_ENS     4 Test  0.262 0.980 0.880 0.881  3.40   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.316</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> FFC_ENS     5 Test  0.467 1.19  0.884 1.69   3.44   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.152</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> FFC_ENS     6 Test  0.207 1.21  0.902 0.638  3.73   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span>  0.018<span style="text-decoration: underline;">0</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> FFC_ENS     7 Test  0.557 1.44  0.880 2.19   3.69   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span>  0.000<span style="text-decoration: underline;">356</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> FFC_ENS     8 Test  0.369 1.03  0.716 1.53   3.24   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span>  0.093<span style="text-decoration: underline;">1</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> FFC_ENS     9 Test  0.523 1.31  0.920 2.18   4.20   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span>  0.111   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> FFC_ENS    10 Test  0.643 1.39  1.14  2.66   5.20   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span>  0.001<span style="text-decoration: underline;">59</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> FFC_ENS    11 Test  0.699 1.44  1.17  2.87   5.18   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.095</span><span style="color: #BB0000; text-decoration: underline;">4</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span> FFC_ENS    12 Test  0.709 1.51  1.39  2.73   5.89   <span style="color: #BB0000;">NaN</span>   <span style="color: #BB0000;">NaN</span> -<span style="color: #BB0000;">0.135</span></span></span>
<span></span>
<span><span class="co"># Create publication-ready plots using fable's autoplot</span></span>
<span><span class="va">fable_forecasts</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_data</span>, show_gap <span class="op">=</span> <span class="cn">FALSE</span>, fill <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>    y <span class="op">=</span> <span class="st">"Temperature (C)"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Forecasts broken down by month"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="elnino-forecasting_files/figure-html/fable-integration-1.png" class="r-plt" alt="El Niño SST forecasts using ensemble model with fable integration. Red ribbons show prediction intervals, black lines show observed values." width="672"><p class="caption">
El Niño SST forecasts using ensemble model with fable integration. Red
ribbons show prediction intervals, black lines show observed values.
</p>
</div>
<p>This integration provides access to <code>fable</code>’s
comprehensive suite of forecast evaluation tools while maintaining the
flexibility and power of functional forecasting methods.</p>
</div>
<div class="section level2">
<h2 id="key-insights-and-best-practices">Key insights and best practices<a class="anchor" aria-label="anchor" href="#key-insights-and-best-practices"></a>
</h2>
<div class="section level3">
<h3 id="when-to-use-cyclic-splines">When to use cyclic splines<a class="anchor" aria-label="anchor" href="#when-to-use-cyclic-splines"></a>
</h3>
<p>Cyclic splines are essential when:<br>
- Data has natural periodicity (seasonal, diurnal, etc.)<br>
- Boundary continuity matters for interpretation<br>
- Forecasting requires smooth transitions across periods</p>
<p>Key implementation tips:<br>
- Set knots just outside the data range: <code>c(0.5, 12.5)</code> for
months 1-12<br>
- Choose k (basis dimension) based on expected complexity<br>
- Use <code>bs = "cc"</code> for cyclic cubic regression splines</p>
<p>For detailed guidance on modeling seasonal data with GAMs, see <a href="https://fromthebottomoftheheap.net/2014/05/09/modelling-seasonal-data-with-gam/" class="external-link">Simpson
(2014)</a>.</p>
</div>
<div class="section level3">
<h3 id="gpdf-model-advantages">GPDF model advantages<a class="anchor" aria-label="anchor" href="#gpdf-model-advantages"></a>
</h3>
<p>The Gaussian Process Dynamic Factor approach excels when:<br>
- Multiple related time series need joint forecasting<br>
- Dimension reduction helps identify shared patterns<br>
- Uncertainty quantification is critical<br>
- Non-linear dynamics are present</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>This vignette demonstrated advanced functional forecasting techniques
using El Niño SST data:</p>
<ul>
<li>Cyclic splines naturally handle seasonal patterns with boundary
continuity<br>
</li>
<li>Time-varying coefficients* capture evolving relationships<br>
</li>
<li>GPDF models provide sophisticated multivariate forecasting<br>
</li>
<li>Comprehensive validation ensures reliable predictions</li>
</ul>
<p>The <code>ffc</code> package integrates these methods in a unified
framework, enabling: - Flexible specification of functional
relationships<br>
- State-of-the-art time series forecasting of coefficients<br>
- Proper uncertainty quantification throughout<br>
- Seamless integration with <a href="https://www.tidyverse.org/" class="external-link"><code>tidyverse</code></a> and
<code>fable</code> ecosystems</p>
<div class="section level3">
<h3 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h3>
<ul>
<li>Hyndman &amp; Athanasopoulos (2021): <a href="https://otexts.com/fpp3/" class="external-link">Forecasting: Principles and
Practice</a>
</li>
<li>Wood (2017): <a href="https://www.routledge.com/Generalized-Additive-Models-An-Introduction-with-R-Second-Edition/Wood/p/book/9781498728331" class="external-link">Generalized
Additive Models: An Introduction with R</a>
</li>
<li>Ramsay &amp; Silverman (2005): <a href="https://link.springer.com/book/10.1007/b98888" class="external-link">Functional Data
Analysis</a>
</li>
<li><a href="https://www.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ensoyears.shtml" class="external-link">NOAA
Climate Prediction Center: ENSO diagnostics and forecasting</a></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://ecogambler.netlify.app/" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
